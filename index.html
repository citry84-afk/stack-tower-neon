<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Tower Neon - Juego de Apilado Gratis | LIPA Studios</title>
    <meta name="description" content="Juega Stack Tower Neon, el juego de apilado m√°s adictivo. Apila bloques perfectamente y alcanza la m√°xima puntuaci√≥n. ¬°Gratis y sin descargas!">
    <meta name="keywords" content="juego apilado, stack tower, juego gratis, neon, arcade, puzzle, bloques">
    <meta name="author" content="LIPA Studios">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Spanish">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://stack-tower-neon.netlify.app/">
    <meta property="og:title" content="Stack Tower Neon - Juego de Apilado Gratis">
    <meta property="og:description" content="Juega Stack Tower Neon, el juego de apilado m√°s adictivo. Apila bloques perfectamente y alcanza la m√°xima puntuaci√≥n.">
    <meta property="og:image" content="https://stack-tower-neon.netlify.app/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://stack-tower-neon.netlify.app/">
    <meta property="twitter:title" content="Stack Tower Neon - Juego de Apilado Gratis">
    <meta property="twitter:description" content="Juega Stack Tower Neon, el juego de apilado m√°s adictivo. Apila bloques perfectamente y alcanza la m√°xima puntuaci√≥n.">
    <meta property="twitter:image" content="https://stack-tower-neon.netlify.app/og-image.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://stack-tower-neon.netlify.app/">
    
    <!-- MONETAG VERIFICATION -->
    <meta name="monetag" content="db5fb5e7115852d031cf96e5b5fe70a2">

    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "VideoGame",
      "name": "Stack Tower Neon",
      "description": "Juego de apilado adictivo con efectos neon espectaculares. Apila bloques perfectamente y alcanza la m√°xima puntuaci√≥n.",
      "url": "https://stack-tower-neon2.netlify.app/",
      "image": "https://stack-tower-neon2.netlify.app/og-image.jpg",
      "genre": "Puzzle",
      "gamePlatform": "Web Browser",
      "operatingSystem": "Any",
      "applicationCategory": "Game",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "EUR"
      },
      "publisher": {
        "@type": "Organization",
        "name": "LIPA Studios",
        "url": "https://lipastudios.com"
      },
      "inLanguage": "es",
      "isAccessibleForFree": true,
      "datePublished": "2024-09-01",
      "dateModified": "2024-09-25"
    }
    </script>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0');
        
            window.trackEvent = function(eventName, parameters = {}) {
                gtag('event', eventName, {
                    event_category: 'game_interaction',
                    ...parameters
                });
            };
            
            window.trackDonationClick = function(amount = 'custom') {
                gtag('event', 'donation_click', {
                    source: 'stack_tower_neon',
                    amount: amount,
                    value: parseFloat(amount) || 1
                });
            };
    </script>
    
    <!-- Google AdSense - REAL MONETIZATION ACTIVE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4837743291717475"
         crossorigin="anonymous"></script>
    <!-- Consent Mode v2 + Banner -->
    <script defer src="/consent.js"></script>
    <!-- Global Leaderboard System -->
    <script src="/leaderboard-global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #050505 0%, #0a0a0a 50%, #1a0a1a 100%);
            color: #00FFFF;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        
        .title {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: 900;
            color: #FF0080;
            text-shadow: 0 0 20px #FF0080;
            margin-bottom: 10px;
            letter-spacing: 0.1em;
        }
        
        .subtitle {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            color: #00FFFF;
            text-shadow: 0 0 15px #00FFFF;
            margin-bottom: 20px;
            letter-spacing: 0.2em;
        }
        
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .screen.active {
            display: flex;
        }
        
        .game-area {
            width: min(400px, 90vw);
            height: 400px;
            border: 2px solid #00FFFF;
            border-radius: 15px;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
            contain: layout style paint;
        }
        
        .block {
            position: absolute;
            border-radius: 5px;
            border: 2px solid #fff;
            transition: none;
        }
        
        .moving-block {
            transition: none;
        }
        
        .perfect {
            animation: perfectGlow 0.5s ease-in-out;
        }
        
        @keyframes perfectGlow {
            0%, 100% { box-shadow: 0 0 10px #39FF14; }
            50% { box-shadow: 0 0 30px #39FF14, 0 0 50px #39FF14; }
        }
        
        .ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: min(400px, 90vw);
            margin: 20px 0;
            padding: 0 10px;
        }
        
        .score {
            font-size: 1.5rem;
            font-weight: 700;
            color: #39FF14;
            text-shadow: 0 0 10px #39FF14;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            background: transparent;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
            min-width: 120px;
            max-width: 180px;
        }
        
        .btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .btn.primary {
            border-color: #FF0080;
            color: #FF0080;
        }
        
        .btn.primary:hover {
            background: rgba(255, 0, 128, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.5);
        }
        
        .btn.donate-btn {
            border-color: #ff6600;
            color: #ff6600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn.donate-btn:hover {
            background: rgba(255, 102, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.5);
        }
        
        .indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 900;
            color: #39FF14;
            text-shadow: 0 0 20px #39FF14;
            z-index: 1000;
            pointer-events: none;
            animation: indicatorPop 1.5s ease-out forwards;
        }
        
        @keyframes indicatorPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        .instructions {
            text-align: center;
            margin: 20px 0;
            color: #00FFFF;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .loading-text {
            font-size: 1.5rem;
            color: #00FFFF;
            text-shadow: 0 0 15px #00FFFF;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .hidden { display: none !important; }
        
        @keyframes topIndicatorSlide {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(0px);
            }
            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0px);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }
        
        @media (max-width: 480px) {
            .controls {
                gap: 10px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
                min-width: 100px;
            }
        }
    </style>
    <!-- FIXES CR√çTICOS STACK TOWER v2.1 -->
    <script src="stack-tower-fixes.js"></script>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen active">
            <div class="title">STACK TOWER</div>
            <div class="subtitle">NEON</div>
            <div class="loading-text">‚ö° CARGANDO GAME...</div>
        </div>
        
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen">
            <div class="title">STACK TOWER</div>
            <div class="subtitle">NEON</div>
            <div class="instructions">
                üéÆ Apila bloques perfectamente<br>
                üéØ Consigue puntos de PERFECTO<br>
                üî• ¬°Haz combos √©picos!
        </div>
        
            <!-- Banner en men√∫ principal -->
            <div id="menu-banner" style="margin: 20px 0; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #00FFFF; border-radius: 8px;">
                <ins class="adsbygoogle" 
                     style="display:block;width:320px;height:50px;" 
                     data-ad-client="ca-pub-4129506161314540" 
                     data-ad-slot="6673201053"></ins>
            </div>
            
            <div class="controls">
                <button class="btn primary" onclick="startGame()">üöÄ JUGAR</button>
                <button class="btn" onclick="showLeaderboardFromMenu()">üèÜ RANKING</button>
                <button class="btn" onclick="toggleAudio()">üîä AUDIO</button>
                <div class="donation-section">
                    <h3 style="color: #FFFF00; margin-bottom: 15px;">üíñ ¬°Apoya el desarrollo!</h3>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="padding: 12px 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">‚òï 0,50‚Ç¨</a>
                        <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #FF9800, #FFC107); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üçï 2‚Ç¨</a>
                        <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #E91E63, #F06292); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üéÆ 5‚Ç¨</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="ui">
                <div class="score" id="score">0</div>
                <div style="color: #FF0080;">NIVEL <span id="level">1</span></div>
    </div>
    
            <div class="game-area" id="game-area"></div>
            
            <div class="controls">
                <button class="btn" onclick="stackBlock()">üì¶ APILAR</button>
                <button class="btn" onclick="pauseGame()" id="pause-btn">‚è∏Ô∏è PAUSA</button>
                <button class="btn" onclick="showMenu()">üè† MENU</button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen">
            <div class="title">GAME OVER</div>
            <div style="font-size: 2rem; color: #39FF14; margin: 20px 0;">
                PUNTOS: <span id="final-score">0</span>
                </div>
            <div id="new-record" class="hidden" style="color: #FF0080; font-size: 1.2rem; margin: 10px 0;">
                üèÜ ¬°NUEVO R√âCORD!
            </div>
            <!-- Interstitial Ad on Game Over -->
            <div id="gameOverAd" style="display:none; text-align:center; margin:20px 0; background:#000014; padding:10px;">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4129506161314540"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
            <div class="controls">
                <button class="btn primary" onclick="restartGame()">üîÑ JUGAR OTRA VEZ</button>
                <button class="btn" onclick="shareScore()">üì§ COMPARTIR</button>
                <div class="donation-section">
                    <h3 style="color: #FFFF00; margin-bottom: 15px;">üíñ ¬°Apoya el desarrollo!</h3>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="padding: 12px 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">‚òï 0,50‚Ç¨</a>
                        <a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #FF9800, #FFC107); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üçï 2‚Ç¨</a>
                        <a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #E91E63, #F06292); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üéÆ 5‚Ç¨</a>
                    </div>
                </div>
                <button class="btn" onclick="showMenu()">üè† MENU</button>
            </div>
        </div>
    </div>
    
        <!-- BANNERS M√ìVIL FIRST - RESPONSIVE -->
        <div id="top-banner" style="position:fixed;top:0;left:0;width:100%;height:60px;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;border-bottom:2px solid #00FFFF;">
            <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
        </div>
        
        <div id="bottom-banner" style="position:fixed;bottom:0;left:0;width:100%;height:60px;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;border-top:2px solid #00FFFF;">
            <ins class="adsbygoogle" style="display:block;width:320px;height:50px;" data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
        </div>
        
        <!-- Banner lateral para m√≥viles (m√°s agresivo) -->
        <div id="side-banner" style="position:fixed; right:10px; top:50%; transform:translateY(-50%); width:120px; height:600px; background:rgba(0,0,0,0.8); border:1px solid #00FFFF; border-radius:8px; display:none; z-index:1000;">
            <ins class="adsbygoogle" 
                 style="display:block;width:120px;height:600px;" 
                 data-ad-client="ca-pub-4129506161314540" 
                 data-ad-slot="6673201053"></ins>
    </div>
    
    <script>
        // DETECCI√ìN DE DISPOSITIVO DE GAMA BAJA (SAMSUNG/ANDROID)
        function detectLowEndDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = /android/.test(userAgent);
            const isSamsung = /samsung/.test(userAgent) || /sm-/.test(userAgent);
            const isLowRAM = navigator.deviceMemory && navigator.deviceMemory < 4;
            const isSlowCPU = navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4;
            const lowEndSamsung = /sm-a|sm-j|sm-g3|sm-g5|sm-g7|sm-g9|sm-t2|sm-t3|sm-t5|sm-t7|sm-p/.test(userAgent);
            
            return (isAndroid && (isSamsung || lowEndSamsung)) || isLowRAM || isSlowCPU;
        }
        
        const isLowEndDevice = detectLowEndDevice();
        console.log('üîß Stack Tower - Dispositivo de gama baja detectado:', isLowEndDevice);
        
        // Simplified Game State
        let gameState = {
            score: 0,
            level: 1,
            blocks: [],
            currentBlock: null,
            gameActive: false,
            audioEnabled: true,
            streak: 0,
            highScore: parseInt(localStorage.getItem('stackTowerHighScore') || '0'),
            isLowEndDevice: isLowEndDevice
        };

        // Daily Leaderboard
        let leaderboard = null;
        
        let gamePaused = false;
        let audioContext = null;
        let backgroundMusicInterval = null;
        
        // Ads helpers (no invasivos)
        // Ads helpers - ESTRATEGIA AGRESIVA PERO INTELIGENTE
        function showAds() {
            const top = document.getElementById('top-banner');
            const bottom = document.getElementById('bottom-banner');
            const side = document.getElementById('side-banner');
            const menu = document.getElementById('menu-banner');
            if (top) top.style.display = 'flex';
            if (bottom) bottom.style.display = 'flex';
            if (side) side.style.display = 'block';
            if (menu) menu.style.display = 'block';
        }
        function hideAds() {
            const top = document.getElementById('top-banner');
            const bottom = document.getElementById('bottom-banner');
            const side = document.getElementById('side-banner');
            const menu = document.getElementById('menu-banner');
            if (top) top.style.display = 'none';
            if (bottom) bottom.style.display = 'none';
            if (side) side.style.display = 'none';
            if (menu) menu.style.display = 'none';
        }
        
        // NUEVA ESTRATEGIA: Mostrar banners despu√©s de 30 segundos de juego
        let gameStartTime = 0;
        let bannerShown = false;
        
        function checkBannerDisplay() {
            // ESTRATEGIA INTELIGENTE - NO MOSTRAR BANNERS DURANTE EL JUEGO
            // Los banners solo se muestran en men√∫ y game over
            return;
        }
        
        // ESTRATEGIA INTELIGENTE - NO MOSTRAR BANNERS EN PAUSA
        function showPauseAds() {
            // Los banners solo se muestran en men√∫ y game over
            return;
        }
        
        // Audio System
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('üîä Audio initialized');
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        function playSound(frequency, duration, type = 'sine', volume = 0.1) {
            if (!audioContext || !gameState.audioEnabled) return;
            
            // OPTIMIZACI√ìN PARA SAMSUNG - DESHABILITAR AUDIO EN DISPOSITIVOS DE GAMA BAJA
            if (gameState.isLowEndDevice) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            } catch (e) {
                console.log('Sound error:', e);
            }
        }
        
        function playPerfectSound() {
            playSound(880, 200, 'square', 0.15);
            setTimeout(() => playSound(1100, 150, 'square', 0.1), 100);
        }
        
        // Background Music System
        function playBackgroundMusic() {
            if (!audioContext || !gameState.audioEnabled) return;
            
            // OPTIMIZACI√ìN PARA SAMSUNG - DESHABILITAR M√öSICA EN DISPOSITIVOS DE GAMA BAJA
            if (gameState.isLowEndDevice) return;
            
            stopBackgroundMusic(); // Stop any existing music
            
            const melody = [
                // Main melody - catchy and addictive like Mario Bros
                {note: 659, duration: 200}, // E5
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 523, duration: 200}, // C5
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 784, duration: 300}, // G5
                {note: 0, duration: 300},   // Rest
                {note: 392, duration: 300}, // G4
                {note: 0, duration: 300},   // Rest
                
                {note: 523, duration: 200}, // C5
                {note: 0, duration: 200},   // Rest
                {note: 392, duration: 200}, // G4
                {note: 0, duration: 200},   // Rest
                {note: 330, duration: 200}, // E4
                {note: 0, duration: 100},   // Rest
                {note: 440, duration: 200}, // A4
                {note: 0, duration: 100},   // Rest
                {note: 494, duration: 200}, // B4
                {note: 0, duration: 100},   // Rest
                {note: 466, duration: 200}, // Bb4
                {note: 440, duration: 200}, // A4
                
                {note: 392, duration: 266}, // G4
                {note: 659, duration: 266}, // E5
                {note: 784, duration: 266}, // G5
                {note: 880, duration: 200}, // A5
                {note: 0, duration: 100},   // Rest
                {note: 698, duration: 200}, // F5
                {note: 784, duration: 200}, // G5
                {note: 0, duration: 200},   // Rest
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 523, duration: 200}, // C5
                {note: 587, duration: 200}, // D5
                {note: 494, duration: 200}  // B4
            ];
            
            let noteIndex = 0;
            
            function playNextNote() {
                if (!gameState.audioEnabled || !gameState.gameActive) return;
                
                const note = melody[noteIndex % melody.length];
                
                if (note.note > 0) {
                    playMusicNote(note.note, note.duration, 0.03);
                }
                
                noteIndex++;
                backgroundMusicInterval = setTimeout(playNextNote, note.duration);
            }
            
            playNextNote();
        }
        
        function playMusicNote(frequency, duration, volume) {
            if (!audioContext) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'square'; // Retro chiptune sound
                
                filter.type = 'lowpass';
                filter.frequency.value = frequency * 2;
                filter.Q.value = 1;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, audioContext.currentTime + duration/1000 * 0.9);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            } catch (e) {
                console.log('Music note error:', e);
            }
        }
        
        function stopBackgroundMusic() {
            if (backgroundMusicInterval) {
                clearTimeout(backgroundMusicInterval);
                backgroundMusicInterval = null;
            }
        }
        
        function playBattleMusic() {
            if (!audioContext || !gameState.audioEnabled) return;
            
            stopBackgroundMusic(); // Stop normal music
            
            const battleMelody = [
                // Faster, more intense melody for high scores
                {note: 784, duration: 150}, // G5
                {note: 880, duration: 150}, // A5
                {note: 988, duration: 150}, // B5
                {note: 1047, duration: 150}, // C6
                {note: 1175, duration: 150}, // D6
                {note: 1319, duration: 150}, // E6
                {note: 1397, duration: 150}, // F6
                {note: 1568, duration: 300}, // G6
                {note: 0, duration: 100},    // Rest
                
                {note: 1568, duration: 100}, // G6
                {note: 1397, duration: 100}, // F6
                {note: 1319, duration: 100}, // E6
                {note: 1175, duration: 100}, // D6
                {note: 1047, duration: 100}, // C6
                {note: 988, duration: 100},  // B5
                {note: 880, duration: 100},  // A5
                {note: 784, duration: 200},  // G5
                {note: 0, duration: 200}     // Rest
            ];
            
            let noteIndex = 0;
            
            function playNextBattleNote() {
                if (!gameState.audioEnabled || !gameState.gameActive) return;
                
                const note = battleMelody[noteIndex % battleMelody.length];
                
                if (note.note > 0) {
                    playMusicNote(note.note, note.duration, 0.04);
                }
                
                noteIndex++;
                backgroundMusicInterval = setTimeout(playNextBattleNote, note.duration);
            }
            
            playNextBattleNote();
        }
        
        function toggleAudio() {
            gameState.audioEnabled = !gameState.audioEnabled;
            const btn = event.target;
            btn.textContent = gameState.audioEnabled ? 'üîä AUDIO' : 'üîá AUDIO';
            
            if (gameState.audioEnabled && audioContext) {
                audioContext.resume();
            }
        }
        
        // Game Logic
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId + '-screen').classList.add('active');
        }
        
        function showMenu() {
            gameState.gameActive = false;
            stopBackgroundMusic(); // Stop music when returning to menu
            showScreen('menu');
        }
        
        function startGame() {
            // Mostrar interstitial ad ocasionalmente (protegido)
            try {
                if (typeof showInterstitialAdFixed === 'function') {
                    showInterstitialAdFixed();
                }
            } catch(e) { /* no-op */ }

            // Asegurar que la pantalla de game over est√© oculta
            const go = document.getElementById('gameover-screen');
            if (go) go.style.display = 'none';
            const gs = document.getElementById('game-screen');
            if (gs) gs.style.display = 'flex';
            hideAds();
            gameState.score = 0;
            gameState.level = 1;
            
            // Reset banner strategy
            bannerShown = false;
            gameStartTime = Date.now();
            gameState.blocks = [];
            gameState.currentBlock = null;
            gameState.gameActive = true;
            gameState.streak = 0;
            gamePaused = false;
            
            showScreen('game');
            
            // Clear game area
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';
            
            // Create base block at bottom
            createBlock(getGameAreaWidth()/2 - 50, 30, 100, '#39FF14', true);
            
            // Create first moving block
            setTimeout(() => createMovingBlock(), 500);
            
            updateUI();
            
            // Start background music
            if (audioContext) {
                audioContext.resume();
                setTimeout(() => {
                    if (gameState.audioEnabled && gameState.gameActive) {
                        playBackgroundMusic();
                    }
                }, 1000);
            }
            try { trackEvent('game_start', { game_name: 'stack_tower_neon' }); } catch(e){}
        }
        
        function getGameAreaWidth() {
            return document.getElementById('game-area').offsetWidth;
        }
        
        function createBlock(x, y, width, color, isBase = false) {
            const block = document.createElement('div');
            block.className = 'block';
            
            // Ensure block stays within game area bounds
            const safeY = Math.max(0, Math.min(350, y)); // Keep within 0-350 range
            const topPosition = Math.max(20, Math.min(370, 400 - safeY - 30));
            
            block.style.left = x + 'px';
            block.style.top = topPosition + 'px';
            block.style.width = width + 'px';
            block.style.height = '30px';
            block.style.backgroundColor = color;
            
            document.getElementById('game-area').appendChild(block);
            
            const blockData = { element: block, x, y: safeY, width, isBase, moving: false };
            gameState.blocks.push(blockData);
            
            return blockData;
        }
        
        function createMovingBlock() {
            if (!gameState.gameActive || gamePaused) return;
            
            const lastBlock = gameState.blocks[gameState.blocks.length - 1];
            const gameAreaWidth = getGameAreaWidth();
            const blockWidth = Math.max(50, 100 - gameState.level * 2);
            
            // Check if tower is getting too high (near top of game area)
            const nextBlockY = lastBlock.y + 35;
            if (nextBlockY > 320 || gameState.blocks.length > 8) { // 320 leaves room for the new block
                scrollCameraSmooth();
                // After scroll, position new block relative to reorganized tower
                const topBlock = gameState.blocks[gameState.blocks.length - 1];
                var newY = topBlock.y + 35;
            } else {
                // Stack blocks upwards - each new block goes higher
                var newY = nextBlockY;
            }
            
            gameState.currentBlock = createBlock(0, newY, blockWidth, getBlockColor(), false);
            gameState.currentBlock.moving = true;
            gameState.currentBlock.element.classList.add('moving-block');
            
            // Add moving animation data
            gameState.currentBlock.direction = 1;
            gameState.currentBlock.speed = 2 + gameState.level * 0.5;
            
            animateBlock(gameState.currentBlock);
        }
        
        function scrollCameraSmooth() {
            // Keep only the last 1 block (the most recent one) - more challenging!
            const blocksToKeep = 1;
            const blocksToRemove = gameState.blocks.length - blocksToKeep;
            
            if (blocksToRemove <= 0) return;
            
            // Remove old blocks from DOM and array
            for (let i = 0; i < blocksToRemove; i++) {
                const blockToRemove = gameState.blocks[i];
                if (blockToRemove.element && blockToRemove.element.parentNode) {
                    blockToRemove.element.parentNode.removeChild(blockToRemove.element);
                }
            }
            
            // Remove from array
            gameState.blocks = gameState.blocks.slice(-blocksToKeep);
            
            // Reposition the remaining block at the bottom
            gameState.blocks.forEach((block, index) => {
                const newY = 30; // Reset to bottom position
                block.y = newY;
                block.element.style.top = (400 - newY - 30) + 'px';
            });
            
            // Visual and audio feedback - positioned at top to not cover blocks
            showTopIndicator('¬°TORRE REORGANIZADA!');
            playSound(880, 200, 'sine', 0.1);
            
            console.log(`üìè Camera scrolled - Blocks remaining: ${gameState.blocks.length}`);
        }
        
        function animateBlock(block) {
            if (!block || !block.moving || !gameState.gameActive || gamePaused) return;
            
            const gameAreaWidth = getGameAreaWidth();
            const newX = block.x + (block.direction * block.speed);
            
            // Bounce off walls
            if (newX <= 0 || newX + block.width >= gameAreaWidth) {
                block.direction *= -1;
                playSound(440, 100, 'square', 0.05);
            }
            
            block.x = Math.max(0, Math.min(gameAreaWidth - block.width, newX));
            block.element.style.left = block.x + 'px';
            
            // OPTIMIZACI√ìN PARA SAMSUNG - MENOS FRECUENCIA DE ANIMACI√ìN
            if (gameState.isLowEndDevice) {
                // En dispositivos de gama baja, usar setTimeout en lugar de requestAnimationFrame
                setTimeout(() => animateBlock(block), 16); // ~60fps
            } else {
                requestAnimationFrame(() => animateBlock(block));
            }
        }
        
        function stackBlock() {
            if (!gameState.currentBlock || !gameState.currentBlock.moving || !gameState.gameActive || gamePaused) return;
            
            const current = gameState.currentBlock;
            current.moving = false;
            current.element.classList.remove('moving-block');
            
            const previous = gameState.blocks[gameState.blocks.length - 2];
            
            // Calculate overlap
            const leftOverlap = Math.max(0, previous.x - current.x);
            const rightOverlap = Math.max(0, (current.x + current.width) - (previous.x + previous.width));
            const totalOverlap = leftOverlap + rightOverlap;
            
            if (totalOverlap >= current.width) {
                // Game over
                gameOver();
                return;
            }
            
            // Trim block
            const newWidth = current.width - totalOverlap;
            const newX = current.x + leftOverlap;
            
            current.x = newX;
            current.width = newWidth;
            current.element.style.left = newX + 'px';
            current.element.style.width = newWidth + 'px';
            current.element.style.top = (400 - current.y - 30) + 'px'; // Update position after trim
            
            // Check for perfect stack
            const perfectThreshold = 5;
            if (totalOverlap <= perfectThreshold) {
                gameState.streak++;
                const points = 10 + gameState.streak;
                gameState.score += points;
                // Mostrar combo visual
                showComboFixed(points);
                // Actualizar velocidad
                updateSpeedFixed();                
                // Perfect effects
                current.element.classList.add('perfect');
                playPerfectSound();
                
                showIndicator('PERFECTO! +' + (points - 1));
                
                if (gameState.streak >= 5) {
                    showComboIndicator(`${gameState.streak}x COMBO!`);
                }
            } else {
                gameState.streak = 0;
                gameState.score += 1;
                playSound(523, 150, 'sine', 0.08);
            }
            
            updateUI();
            
            // Level progression
            if (gameState.score > 0 && gameState.score % 20 === 0) {
                gameState.level++;
                showIndicator(`¬°NIVEL ${gameState.level}!`);
            }
            
            // Create next block
            setTimeout(() => createMovingBlock(), 1000);
        }
        
        function showIndicator(text) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.textContent = text;
            document.getElementById('game-area').appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1500);
        }
        
        function showComboIndicator(text) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.color = '#FF0080';
            indicator.style.textShadow = '0 0 20px #FF0080';
            indicator.textContent = text;
            document.getElementById('game-area').appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }
        
        function showTopIndicator(text) {
            const indicator = document.createElement('div');
            indicator.style.position = 'absolute';
            indicator.style.top = '10px'; // Near the top edge
            indicator.style.left = '50%';
            indicator.style.transform = 'translateX(-50%)';
            indicator.style.fontSize = '1.2rem';
            indicator.style.fontWeight = '900';
            indicator.style.color = '#FFD700';
            indicator.style.textShadow = '0 0 15px #FFD700';
            indicator.style.zIndex = '1000';
            indicator.style.pointerEvents = 'none';
            indicator.style.animation = 'topIndicatorSlide 2s ease-out forwards';
            indicator.textContent = text;
            document.getElementById('game-area').appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }
        
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            
            // Verificar si mostrar banners despu√©s de 30s
            checkBannerDisplay();
            
            // Update high score
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('stackTowerHighScore', gameState.highScore.toString());
            }
            
            // Switch to battle music at 50 points
            if (gameState.score === 50 && gameState.audioEnabled && backgroundMusicInterval) {
                playBattleMusic();
                showIndicator('¬°MODO BATALLA!');
            }
        }
        
        // CONTADOR DE PARTIDAS PARA ESTRATEGIA INTELIGENTE
        let gamesPlayed = 0;
        let lastInterstitialTime = 0;
        
        function gameOver() {
            gameState.gameActive = false;
            stopBackgroundMusic(); // Stop music on game over
            playSound(220, 300, 'sawtooth', 0.15);
            
            gamesPlayed++;
            const currentTime = Date.now();
            
            setTimeout(() => {
                document.getElementById('final-score').textContent = gameState.score;
                
                if (gameState.score === gameState.highScore && gameState.score > 0) {
                    document.getElementById('new-record').classList.remove('hidden');
                } else {
                    document.getElementById('new-record').classList.add('hidden');
                }
                
                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('gameover-screen').style.display = 'flex';
                
                // ESTRATEGIA INTELIGENTE DE MONETIZACI√ìN
                // 1. Siempre mostrar banners en game over (no invasivo)
                showAds();
                
                // 2. Interstitial solo cada 3 partidas perdidas Y cada 5 minutos m√≠nimo
                const timeSinceLastInterstitial = currentTime - lastInterstitialTime;
                const shouldShowInterstitial = (gamesPlayed % 3 === 0) && (timeSinceLastInterstitial > 300000); // 5 minutos
                
                if (shouldShowInterstitial) {
                    const ad = document.getElementById('gameOverAd'); 
                    if (ad) ad.style.display='block';
                    lastInterstitialTime = currentTime;
                    try { trackEvent('ad_impression', { game_name:'stack_tower_neon', ad_type:'interstitial' }); } catch(e){}
                }
                
                // üèÜ INTEGRACI√ìN DEL LEADERBOARD - MOSTRAR RANKING DESPU√âS DE GAME OVER
                setTimeout(() => {
                    if (leaderboard) {
                        // Enviar puntuaci√≥n al leaderboard (esto mostrar√° el prompt de nombre si es necesario)
                        leaderboard.submitScore(gameState.score, gameState.level, gameState.streak);
                    } else {
                        // Si no hay leaderboard, crear uno nuevo
                        leaderboard = new GlobalLeaderboard('stack-tower-neon');
                        leaderboard.submitScore(gameState.score, gameState.level, gameState.streak);
                    }
                }, 1000); // Esperar 1 segundo para que se vea la pantalla de game over
                
                try { trackEvent('game_over', { game_name:'stack_tower_neon', score: gameState.score }); } catch(e){}
            }, 500);
        }

function gameOverOriginal() {
            gameState.gameActive = false;
            stopBackgroundMusic(); // Stop music on game over
            playSound(220, 300, 'sawtooth', 0.15);
            
            setTimeout(() => {
                document.getElementById('final-score').textContent = gameState.score;
                
                if (gameState.score === gameState.highScore && gameState.score > 0) {
                    document.getElementById('new-record').classList.remove('hidden');
                } else {
                    document.getElementById('new-record').classList.add('hidden');
                }
                
                showScreen('gameover');
            }, 1000);
        }
        
        function pauseGame() {
            if (!gameState.gameActive) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                document.getElementById('pause-btn').textContent = '‚ñ∂Ô∏è REANUDAR';
                stopBackgroundMusic(); // Pause music
            } else {
                document.getElementById('pause-btn').textContent = '‚è∏Ô∏è PAUSA';
                
                // Resume animation if there's a moving block
                if (gameState.currentBlock && gameState.currentBlock.moving) {
                    animateBlock(gameState.currentBlock);
                }
                
                // Resume music when unpausing
                if (gameState.audioEnabled) {
                    setTimeout(() => {
                        if (gameState.score >= 50) {
                            playBattleMusic();
                        } else {
                            playBackgroundMusic();
                        }
                    }, 500);
                }
            }
        }
        
        function getBlockColor() {
            const colors = ['#FF0080', '#00FFFF', '#39FF14', '#FFD700', '#FF4500', '#8A2BE2'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function shareScore() {
            // Texto viral s√∫per atractivo
            const score = gameState.score;
            const level = gameState.level;
            
            let viralText = '';
            let title = '';
            
            if (score >= 100) {
                viralText = `üî• ¬°S√öPER R√âCORD! Acabo de construir una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüíé Nivel alcanzado: ${level}\nüéØ ¬øEres capaz de superar mi r√©cord?\n\nüöÄ Juega GRATIS aqu√≠: ${window.location.href}\n\n#StackTowerNeon #GamingChallenge #ViralGame #NeonGaming`;
                title = 'üî• S√öPER R√âCORD - Stack Tower Neon';
            } else if (score >= 50) {
                viralText = `‚ö° ¬°INCRE√çBLE! Constru√≠ una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüéÆ Nivel: ${level}\nüí™ ¬øPuedes hacerlo mejor?\n\nüéØ Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Challenge #NeonGaming`;
                title = '‚ö° R√âCORD INCRE√çBLE - Stack Tower Neon';
            } else {
                viralText = `üéÆ ¬°Acabo de jugar Stack Tower Neon! üèóÔ∏è\n\nüìä Mi puntuaci√≥n: ${score} bloques\nüéØ Nivel: ${level}\n\nüöÄ ¬°Es s√∫per adictivo! ¬øQuieres probarlo?\n\nüíé Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Adictivo #NeonGaming`;
                title = 'üéÆ Stack Tower Neon - ¬°S√∫per Adictivo!';
            }
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: viralText,
                    url: window.location.href
                });
            } else {
                // Mostrar modal de compartir con opciones
                showShareModal(viralText, title);
            }
        }
        
        function showShareModal(text, title) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); display: flex; justify-content: center;
                align-items: center; z-index: 10000; font-family: 'Orbitron', monospace;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(145deg, #1a1a2e, #16213e); padding: 30px;
                           border-radius: 20px; text-align: center; border: 3px solid #00FFFF;
                           box-shadow: 0 0 30px #FF0080; max-width: 90%;">
                    <h2 style="color: #FF0080; margin: 20px 0;">üéÆ ¬°COMPARTE TU R√âCORD!</h2>
                    <div style="margin: 20px 0; color: white;">
                        <p>üèóÔ∏è Score: ${gameState.score}</p>
                        <p>üìà Level: ${gameState.level}</p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="shareToTwitter()" style="background: #1DA1F2; color: white; border: none;
                                padding: 10px 20px; border-radius: 8px; cursor: pointer;">üê¶ Twitter</button>
                        <button onclick="shareToFacebook()" style="background: #4267B2; color: white; border: none;
                                padding: 10px 20px; border-radius: 8px; cursor: pointer;">üìò Facebook</button>
                        <button onclick="shareToWhatsApp()" style="background: #25D366; color: white; border: none;
                                padding: 10px 20px; border-radius: 8px; cursor: pointer;">üí¨ WhatsApp</button>
                        <button onclick="copyToClipboard()" style="background: #FF0080; color: white; border: none;
                                padding: 10px 20px; border-radius: 8px; cursor: pointer;">üìã Copiar</button>
                        <button onclick="closeShareModal()" style="background: #666; color: white; border: none;
                                padding: 10px 20px; border-radius: 8px; cursor: pointer;">‚ùå Cerrar</button>
                    </div>
    </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function shareToTwitter() {
            const score = gameState.score;
            const level = gameState.level;
            let text = '';
            
            if (score >= 100) {
                text = `üî• ¬°S√öPER R√âCORD! Acabo de construir una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüíé Nivel: ${level}\nüéØ ¬øEres capaz de superar mi r√©cord?\n\nüöÄ Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #GamingChallenge #ViralGame`;
            } else if (score >= 50) {
                text = `‚ö° ¬°INCRE√çBLE! Constru√≠ una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüéÆ Nivel: ${level}\nüí™ ¬øPuedes hacerlo mejor?\n\nüéØ Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Challenge`;
            } else {
                text = `üéÆ ¬°Acabo de jugar Stack Tower Neon! üèóÔ∏è\n\nüìä Mi puntuaci√≥n: ${score} bloques\nüéØ Nivel: ${level}\n\nüöÄ ¬°Es s√∫per adictivo! ¬øQuieres probarlo?\n\nüíé Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Adictivo`;
            }
            
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
            closeShareModal();
        }
        
        function shareToFacebook() {
            const score = gameState.score;
            const level = gameState.level;
            let text = '';
            
            if (score >= 100) {
                text = `üî• ¬°S√öPER R√âCORD! Acabo de construir una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüíé Nivel: ${level}\nüéØ ¬øEres capaz de superar mi r√©cord?\n\nüöÄ Juega GRATIS: ${window.location.href}`;
            } else if (score >= 50) {
                text = `‚ö° ¬°INCRE√çBLE! Constru√≠ una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüéÆ Nivel: ${level}\nüí™ ¬øPuedes hacerlo mejor?\n\nüéØ Juega GRATIS: ${window.location.href}`;
            } else {
                text = `üéÆ ¬°Acabo de jugar Stack Tower Neon! üèóÔ∏è\n\nüìä Mi puntuaci√≥n: ${score} bloques\nüéØ Nivel: ${level}\n\nüöÄ ¬°Es s√∫per adictivo! ¬øQuieres probarlo?\n\nüíé Juega GRATIS: ${window.location.href}`;
            }
            
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
            closeShareModal();
        }
        
        function shareToWhatsApp() {
            const score = gameState.score;
            const level = gameState.level;
            let text = '';
            
            if (score >= 100) {
                text = `üî• ¬°S√öPER R√âCORD! Acabo de construir una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüíé Nivel: ${level}\nüéØ ¬øEres capaz de superar mi r√©cord?\n\nüöÄ Juega GRATIS: ${window.location.href}`;
            } else if (score >= 50) {
                text = `‚ö° ¬°INCRE√çBLE! Constru√≠ una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüéÆ Nivel: ${level}\nüí™ ¬øPuedes hacerlo mejor?\n\nüéØ Juega GRATIS: ${window.location.href}`;
            } else {
                text = `üéÆ ¬°Acabo de jugar Stack Tower Neon! üèóÔ∏è\n\nüìä Mi puntuaci√≥n: ${score} bloques\nüéØ Nivel: ${level}\n\nüöÄ ¬°Es s√∫per adictivo! ¬øQuieres probarlo?\n\nüíé Juega GRATIS: ${window.location.href}`;
            }
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
            closeShareModal();
        }
        
        function copyToClipboard() {
            const score = gameState.score;
            const level = gameState.level;
            let text = '';
            
            if (score >= 100) {
                text = `üî• ¬°S√öPER R√âCORD! Acabo de construir una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüíé Nivel: ${level}\nüéØ ¬øEres capaz de superar mi r√©cord?\n\nüöÄ Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #GamingChallenge #ViralGame #NeonGaming`;
            } else if (score >= 50) {
                text = `‚ö° ¬°INCRE√çBLE! Constru√≠ una torre de ${score} bloques en Stack Tower Neon! üèóÔ∏è\n\nüéÆ Nivel: ${level}\nüí™ ¬øPuedes hacerlo mejor?\n\nüéØ Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Challenge #NeonGaming`;
            } else {
                text = `üéÆ ¬°Acabo de jugar Stack Tower Neon! üèóÔ∏è\n\nüìä Mi puntuaci√≥n: ${score} bloques\nüéØ Nivel: ${level}\n\nüöÄ ¬°Es s√∫per adictivo! ¬øQuieres probarlo?\n\nüíé Juega GRATIS: ${window.location.href}\n\n#StackTowerNeon #Gaming #Adictivo #NeonGaming`;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                alert('üìã ¬°Texto copiado al portapapeles!');
            }).catch(() => {
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üìã ¬°Texto copiado al portapapeles!');
            });
            closeShareModal();
        }
        
        function closeShareModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }

function shareScoreOriginal() {
            const text = `üåà ¬°Consegu√≠ ${gameState.score} puntos en Stack Tower Neon! ¬øPuedes superarme?`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Stack Tower Neon',
                    text: text,
                    url: window.location.href
                });
            } else {
                // Fallback
                const url = encodeURIComponent(window.location.href);
                const shareText = encodeURIComponent(text);
                const shareUrl = `https://twitter.com/intent/tweet?text=${shareText}&url=${url}`;
                window.open(shareUrl, '_blank');
            }
        }
        
        // Event Listeners
        document.getElementById('game-area').addEventListener('click', stackBlock);
        document.getElementById('game-area').addEventListener('touchstart', (e) => {
            e.preventDefault();
            stackBlock();
        });
        
        // Global tap/click: permitir apilar tocando en cualquier parte durante el juego
        function isGameActiveScreen() {
            const gs = document.getElementById('game-screen');
            return gs && (gs.classList.contains('active') || gs.style.display === 'flex');
        }
        
        document.addEventListener('touchstart', (e) => {
            if (!isGameActiveScreen() || !gameState.gameActive || gamePaused) return;
            if (e.target.closest('.controls')) return; // no interceptar botones
            try { e.preventDefault(); } catch(_) {}
            stackBlock();
        }, { passive: false });
        
        document.addEventListener('click', (e) => {
            if (!isGameActiveScreen() || !gameState.gameActive || gamePaused) return;
            if (e.target.closest('.controls')) return;
            stackBlock();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                stackBlock();
            }
        });
        
        // üèÜ FUNCI√ìN PARA MOSTRAR RANKING DESDE EL MEN√ö
        function showLeaderboardFromMenu() {
            if (!leaderboard) {
                leaderboard = new GlobalLeaderboard('stack-tower-neon');
            }
            
            // Si no hay usuario, pedir nombre primero
            if (!leaderboard.currentUser) {
                leaderboard.showNamePrompt(false);
                // Despu√©s de que el usuario ingrese su nombre, mostrar el ranking
                setTimeout(() => {
                    if (leaderboard.currentUser) {
                        leaderboard.showRanking({ 
                            name: leaderboard.currentUser.name, 
                            score: leaderboard.currentUser.bestScore || 0 
                        });
                    }
                }, 100);
            } else {
                // Mostrar ranking directamente
                leaderboard.showRanking({ 
                    name: leaderboard.currentUser.name, 
                    score: leaderboard.currentUser.bestScore || 0 
                });
            }
        }

        // Initialize
        setTimeout(() => {
            initAudio();
            hideAds();
            showMenu();
            
            // Initialize leaderboard
            leaderboard = new GlobalLeaderboard('stack-tower-neon');
            
            try { trackEvent('page_view', { game_name:'stack_tower_neon' }); } catch(e){}
        }, 1500);

        function restartGame(){
            const ad = document.getElementById('gameOverAd'); 
            if (ad) ad.style.display='none';
            
            // Ocultar pantalla de game over
            document.getElementById('gameover-screen').style.display = 'none';
            
            try { trackEvent('game_restart', { game_name:'stack_tower_neon' }); } catch(e){}
            startGame();
        }
        
        console.log('üéÆ Stack Tower Neon - TEST VERSION LOADED!');
    </script>
    
    <!-- Footer Navigation for SEO -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 10px; text-align: center; font-size: 12px; z-index: 1000; display: none;" id="footerNav">
        <a href="/privacy.html" style="color: #00ffff; margin: 0 10px;">Privacidad</a>
        <a href="/terms.html" style="color: #00ffff; margin: 0 10px;">T√©rminos</a>
        <a href="/contact.html" style="color: #00ffff; margin: 0 10px;">Contacto</a>
        <a href="/about.html" style="color: #00ffff; margin: 0 10px;">Sobre Nosotros</a>
        <a href="/help.html" style="color: #00ffff; margin: 0 10px;">Ayuda</a>
        <a href="/news.html" style="color: #00ffff; margin: 0 10px;">Noticias</a>
    </div>
    
</body>
</html>
