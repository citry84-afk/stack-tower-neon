<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack Tower Neon - Juego Adictivo | Gratis Online</title>
    
    <!-- Google Analytics 4 - Revenue Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0', {
            custom_map: {'custom_parameter_1': 'revenue_source'},
            send_page_view: true,
            allow_google_signals: true,
            allow_ad_personalization_signals: true
        });
        
        // Enhanced event tracking for monetization optimization
        window.trackEvent = function(eventName, parameters = {}) {
            gtag('event', eventName, {
                event_category: 'game_interaction',
                event_label: parameters.label || eventName,
                value: parameters.value || 0,
                currency: 'EUR',
                revenue_source: parameters.revenue_source || 'organic',
                user_engagement: parameters.engagement || 'medium',
                session_duration: Math.floor((Date.now() - window.sessionStart) / 1000),
                ...parameters
            });
            console.log('📊 Revenue Event:', eventName, parameters);
        };
        
        // Revenue tracking for ads
        window.trackRevenue = function(amount, source = 'display_ads', adType = 'banner') {
            gtag('event', 'purchase', {
                transaction_id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                value: amount,
                currency: 'EUR',
                revenue_source: source,
                ad_type: adType,
                items: [{
                    item_id: `ad_${adType}_${Date.now()}`,
                    item_name: `Ad Revenue - ${adType}`,
                    category: 'advertising',
                    quantity: 1,
                    price: amount
                }]
            });
            
            // Update session revenue
            window.sessionRevenue = (window.sessionRevenue || 0) + amount;
            console.log(`💰 Revenue: €${amount} from ${source} | Session Total: €${window.sessionRevenue.toFixed(4)}`);
        };
        
        // User engagement and retention tracking
        window.trackEngagement = function(action, score = 1, extra = {}) {
            gtag('event', 'user_engagement', {
                engagement_time_msec: Date.now() - window.sessionStart,
                engagement_action: action,
                engagement_score: score,
                games_played: window.gamesPlayedSession || 0,
                ...extra
            });
        };
        
        // Session and conversion tracking
        window.sessionStart = Date.now();
        window.sessionRevenue = 0;
        window.gamesPlayedSession = 0;
        
        // Track high-value user actions
        window.trackConversion = function(type, value = 0) {
            gtag('event', 'conversion', {
                conversion_type: type,
                conversion_value: value,
                currency: 'EUR'
            });
        };
    </script>
    
    <!-- Google AdSense - REAL MONETIZATION ACTIVE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4129506161314540" crossorigin="anonymous"></script>
    
    <!-- Advanced Analytics & Ads Integration - Embedded for standalone compatibility -->
    
    <!-- H5 Games Ads API -->
    <script>
        window.adBreak = window.adBreak || function(o) {
            console.log('🎮 Ad Break Request:', o.type, o.name);
            
            // Track ad request
            window.trackEvent('ad_requested', {
                ad_type: o.type,
                ad_name: o.name,
                revenue_source: 'h5_games'
            });
            
            if (o.beforeAd) o.beforeAd();
            
            // Simulate ad with realistic timing
            const adDuration = o.type === 'reward' ? 30000 : 15000; // 30s rewarded, 15s interstitial
            
            setTimeout(() => {
                const revenue = o.type === 'reward' ? 0.12 : 0.08; // Higher for rewarded
                
                if (Math.random() > 0.15) { // 85% ad completion rate
                    if (o.adViewed) o.adViewed();
                    window.trackRevenue(revenue, 'h5_games', o.type);
                    window.trackEvent('ad_completed', {
                        ad_type: o.type,
                        ad_name: o.name,
                        revenue: revenue
                    });
                } else {
                    if (o.adDismissed) o.adDismissed();
                    window.trackEvent('ad_dismissed', {
                        ad_type: o.type,
                        ad_name: o.name
                    });
                }
                
                if (o.afterAd) o.afterAd();
            }, Math.min(adDuration, 3000)); // Quick simulation for testing
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #050505 0%, #0a0a0a 50%, #1a0a1a 100%);
            color: #00FFFF;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        
        .title {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: 900;
            color: #FF0080;
            text-shadow: 0 0 20px #FF0080;
            margin-bottom: 10px;
            letter-spacing: 0.1em;
        }
        
        .subtitle {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            color: #00FFFF;
            text-shadow: 0 0 15px #00FFFF;
            margin-bottom: 20px;
            letter-spacing: 0.2em;
        }
        
        .game-area {
            width: min(350px, 85vw);
            height: 400px;
            border: 2px solid #00FFFF;
            border-radius: 10px;
            position: relative;
            background: rgba(0, 0, 0, 0.8);
            margin-bottom: 15px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            overflow: hidden;
            /* Ensure blocks stay within bounds */
            contain: layout style paint;
        }
        
        .block {
            position: absolute;
            height: 30px;
            border: 1px solid;
            border-radius: 5px;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px currentColor;
        }
        
        .block.perfect {
            animation: perfectGlow 0.5s ease-out;
        }
        
        @keyframes perfectGlow {
            0% { transform: scale(1); box-shadow: 0 0 10px currentColor; }
            50% { transform: scale(1.05); box-shadow: 0 0 20px currentColor; }
            100% { transform: scale(1); box-shadow: 0 0 10px currentColor; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }
        
        .btn {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00FFFF;
            border-radius: 8px;
            color: #00FFFF;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 100px;
            text-align: center;
        }
        
        .btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.primary {
            border-color: #FF0080;
            color: #FF0080;
        }
        
        .btn.primary:hover {
            background: rgba(255, 0, 128, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.5);
        }
        
        .score-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }
        
        .score-item {
            background: rgba(16, 16, 16, 0.9);
            border: 1px solid #00FFFF;
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            min-width: 70px;
            flex: 1;
            max-width: 120px;
        }
        
        .score-label {
            font-size: 0.6rem;
            opacity: 0.8;
            display: block;
            margin-bottom: 3px;
            letter-spacing: 0.1em;
        }
        
        .score-value {
            font-size: 1.1rem;
            font-weight: 900;
            color: #FFFF00;
            text-shadow: 0 0 10px #FFFF00;
            display: block;
        }
        
        .instructions {
            text-align: center;
            margin-top: 10px;
            color: #39FF14;
            font-size: 0.7rem;
            line-height: 1.3;
            max-width: 350px;
            opacity: 0.9;
        }
        
        .hidden {
            display: none !important;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            transition: opacity 0.3s ease;
        }
        
        .screen.fade-out {
            opacity: 0;
        }
        
        /* Indicators */
        .indicator {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #39FF14;
            color: #000;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 900;
            z-index: 9999;
            pointer-events: none;
            animation: indicatorPop 1s ease-out forwards;
        }
        
        @keyframes indicatorPop {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            70% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
        }
        
        .combo-indicator {
            position: fixed;
            top: 20%;
            right: 20px;
            background: #FFFF00;
            color: #000;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 0.9rem;
            z-index: 9999;
            animation: comboShake 0.5s ease-in-out;
        }
        
        @keyframes comboShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        
        .level-up {
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FF0080;
            color: #FFF;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: 900;
            z-index: 9999;
            pointer-events: none;
            animation: levelUpBounce 1.5s ease-out forwards;
        }
        
        @keyframes levelUpBounce {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
        }
        
        /* Ad banners - MOBILE-FIRST NON-INTRUSIVE */
        .ad-banner {
            background: rgba(0, 0, 0, 0.85);
            color: #888;
            padding: 5px;
            text-align: center;
            position: fixed;
            width: 100%;
            z-index: 1000;
            font-size: 0.6rem;
            border: 1px solid #333;
            transition: opacity 0.3s ease;
        }
        
        .ad-top { 
            top: 0; 
            height: 60px; /* Más pequeño para móviles */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ad-bottom { 
            bottom: 0; 
            height: 60px; /* Más pequeño para móviles */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-ad {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            width: 160px;
            height: 600px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00FFFF;
            border-radius: 8px;
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0;
                transform: translateY(-50%) translateX(100%);
            }
            to { 
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }
        
        .ad-close {
            background: #666;
            border: none;
            color: white;
            padding: 2px 6px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        /* Game area adjustments for ads */
        .container {
            padding-top: 50px;
            padding-bottom: 50px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 50px 10px;
            }
            
            .game-area {
                width: 95vw;
                height: 350px;
            }
            
            .controls {
                gap: 8px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.7rem;
                min-width: 80px;
            }
            
            .score-panel {
                gap: 8px;
            }
            
            .score-item {
                padding: 6px 10px;
                min-width: 60px;
            }
            
            .score-value {
                font-size: 1rem;
            }
            
            .instructions {
                font-size: 0.6rem;
            }
        }
        
        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 600px) {
            .title {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .subtitle {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .game-area {
                height: 300px;
            }
            
            .controls, .score-panel {
                margin-bottom: 8px;
            }
            
            .btn {
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Ad Banners - HIGHLY VISIBLE -->
    <div class="ad-banner ad-top" id="top-ad-banner">
        <!-- Google AdSense Top Banner - REAL MONETIZATION -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4129506161314540"
             data-ad-slot="auto"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            // Track banner ad impression
            window.trackRevenue(0.02, 'display_ads', 'top_banner');
        </script>
        <button class="ad-close" onclick="this.parentElement.style.display='none'; window.trackEvent('ad_closed', {ad_type: 'top_banner'});">×</button>
    </div>
    
    <div class="container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen">
            <div class="title">STACK TOWER</div>
            <div class="subtitle">NEON</div>
            <div style="color: #39FF14; font-size: 1rem;">Cargando...</div>
        </div>
        
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen hidden">
            <div class="title">STACK TOWER</div>
            <div class="subtitle">NEON</div>
            <div class="controls">
                <button class="btn primary" onclick="startGame()">🎮 JUGAR</button>
                <button class="btn" onclick="showInstructions()">📖 AYUDA</button>
                <button class="btn" onclick="toggleAudio()">🔊 AUDIO</button>
            </div>
            <div class="score-panel">
                <div class="score-item">
                    <span class="score-label">RÉCORD</span>
                    <span id="high-score" class="score-value">0</span>
            </div>
            </div>
        </div>
        
        <!-- Instructions Screen -->
        <div id="instructions-screen" class="screen hidden">
            <div class="title">CÓMO JUGAR</div>
            <div class="instructions" style="font-size: 0.9rem; max-width: 300px; margin: 20px 0;">
                <p style="margin: 15px 0;">👆 <strong>TOCA LA PANTALLA</strong> para apilar</p>
                <p style="margin: 15px 0;">🎯 <strong>APILA PERFECTO</strong> para +3 puntos</p>
                <p style="margin: 15px 0;">🔥 <strong>RACHAS 5+</strong> dan +5 puntos extra</p>
                <p style="margin: 15px 0;">⚡ <strong>VELOCIDAD AUMENTA</strong> cada nivel</p>
            </div>
            <div class="controls">
                <button class="btn primary" onclick="showMenu()">VOLVER</button>
            </div>
    </div>
    
        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="score-panel">
                <div class="score-item">
                    <span class="score-label">PUNTOS</span>
                    <span id="current-score" class="score-value">0</span>
        </div>
                <div class="score-item">
                    <span class="score-label">RACHA</span>
                    <span id="streak" class="score-value">0</span>
        </div>
                <div class="score-item">
                    <span class="score-label">NIVEL</span>
                    <span id="level" class="score-value">1</span>
        </div>
    </div>
    
            <div class="game-area" id="game-area">
                <!-- Blocks will be added here -->
            </div>
            
            <div class="controls">
                <button class="btn primary" onclick="stackBlock()">📦 APILAR</button>
                <button class="btn" onclick="pauseGame()" id="pause-btn">⏸️ PAUSA</button>
                <button class="btn" onclick="showMenu()">🏠 MENÚ</button>
        </div>
        
            <div class="instructions">
                <p><strong>TOCA CUALQUIER PARTE</strong> de la pantalla o presiona <strong>ESPACIO</strong></p>
                </div>
            </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen hidden">
            <div class="title" style="color: #FF4500;">GAME OVER</div>
            <div class="score-panel">
                <div class="score-item">
                    <span class="score-label">PUNTUACIÓN</span>
                    <span id="final-score" class="score-value">0</span>
            </div>
        </div>
            <div id="new-record" class="hidden" style="color: #39FF14; font-size: 1.2rem; margin: 10px 0; font-weight: 900;">
                🏆 ¡NUEVO RÉCORD! 🏆
    </div>
    
            <!-- Game Over AdSense Banner - REAL MONETIZATION -->
            <div style="margin: 20px 0; text-align: center;">
                <ins class="adsbygoogle"
                     style="display:block;width:320px;height:100px"
                     data-ad-client="ca-pub-4129506161314540"
                     data-ad-slot="auto"
                     data-ad-format="rectangle"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
        </div>
            
            <div class="controls">
                <button class="btn primary" onclick="showRewardedAd()">📺 CONTINUAR</button>
                <button class="btn" onclick="startGame()">🔄 REINICIAR</button>
                <button class="btn" onclick="shareScore()">📤 COMPARTIR</button>
            </div>
        </div>
    </div>
    
    <div class="ad-banner ad-bottom" id="bottom-ad-banner">
        <!-- Google AdSense Bottom Banner - REAL MONETIZATION -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4129506161314540"
             data-ad-slot="auto"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            // Track banner ad impression
            window.trackRevenue(0.025, 'display_ads', 'bottom_banner');
        </script>
        <button class="ad-close" onclick="this.parentElement.style.display='none'; window.trackEvent('ad_closed', {ad_type: 'bottom_banner'});">×</button>
    </div>
    
    <!-- Floating/Sticky Ad (Appears after engagement) -->
    <div class="ad-banner floating-ad hidden" id="floating-ad">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-4129506161314540"
             data-ad-slot="auto"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
        <button class="ad-close" onclick="this.parentElement.classList.add('hidden'); window.trackEvent('ad_closed', {ad_type: 'floating_ad'});">×</button>
    </div>
    
    <script>
        // Optimized Game State
        let gameState = {
            score: 0,
            highScore: parseInt(localStorage.getItem('stackTowerHighScore') || '0'),
            streak: 0,
            level: 1,
            blocks: [],
            currentBlock: null,
            gameActive: false,
            audioEnabled: true,
            cameraOffset: 0
        };
        
        let currentScreen = 'loading';
        let gamePaused = false;
        let audioContext = null;
        
        // Enhanced Audio System with Background Music
        let backgroundMusicInterval = null;
        let musicVolume = 0.03;
        
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // Retro Background Music - Addictive Mario Bros Style
        function playBackgroundMusic() {
            if (!gameState.audioEnabled || !audioContext || backgroundMusicInterval) return;
            
            const melody = [
                // Main melody - catchy and addictive like Mario Bros
                {note: 659, duration: 200}, // E5
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 523, duration: 200}, // C5
                {note: 659, duration: 200}, // E5
                {note: 0, duration: 100},   // Rest
                {note: 784, duration: 300}, // G5
                {note: 0, duration: 300},   // Rest
                {note: 392, duration: 300}, // G4
                {note: 0, duration: 300},   // Rest
                
                {note: 523, duration: 300}, // C5
                {note: 0, duration: 200},   // Rest
                {note: 392, duration: 200}, // G4
                {note: 0, duration: 200},   // Rest
                {note: 330, duration: 300}, // E4
                {note: 0, duration: 200},   // Rest
                {note: 440, duration: 200}, // A4
                {note: 0, duration: 100},   // Rest
                {note: 494, duration: 200}, // B4
                {note: 0, duration: 100},   // Rest
                {note: 466, duration: 200}, // Bb4
                {note: 440, duration: 200}, // A4
                
                {note: 392, duration: 300}, // G4
                {note: 659, duration: 300}, // E5
                {note: 784, duration: 300}, // G5
                {note: 880, duration: 300}, // A5
                {note: 698, duration: 200}, // F5
                {note: 784, duration: 200}, // G5
                {note: 0, duration: 100},   // Rest
                {note: 659, duration: 300}, // E5
                {note: 523, duration: 200}, // C5
                {note: 587, duration: 200}, // D5
                {note: 494, duration: 300}, // B4
                {note: 0, duration: 300},   // Rest
            ];
            
            let noteIndex = 0;
            
            function playNextNote() {
                if (!gameState.audioEnabled || !audioContext) {
                    stopBackgroundMusic();
                    return;
                }
                
                const currentNote = melody[noteIndex];
                
                if (currentNote.note > 0) {
                    playMusicNote(currentNote.note, currentNote.duration, musicVolume);
                }
                
                noteIndex = (noteIndex + 1) % melody.length;
                
                backgroundMusicInterval = setTimeout(playNextNote, currentNote.duration);
            }
            
            playNextNote();
        }
        
        function playMusicNote(frequency, duration, volume) {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'square'; // Retro chiptune sound
                
                // Add retro filter effect
                filter.type = 'lowpass';
                filter.frequency.value = frequency * 2;
                filter.Q.value = 1;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(volume * 0.3, audioContext.currentTime + duration/1000 * 0.9);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            } catch (e) {
                console.log('Music note error:', e);
            }
        }
        
        function stopBackgroundMusic() {
            if (backgroundMusicInterval) {
                clearTimeout(backgroundMusicInterval);
                backgroundMusicInterval = null;
            }
        }
        
        // Fast-paced battle music for high scores
        function playBattleMusic() {
            stopBackgroundMusic();
            
            const battleMelody = [
                {note: 880, duration: 150}, // A5
                {note: 932, duration: 150}, // Bb5
                {note: 880, duration: 150}, // A5
                {note: 784, duration: 150}, // G5
                {note: 659, duration: 150}, // E5
                {note: 784, duration: 150}, // G5
                {note: 880, duration: 300}, // A5
                {note: 0, duration: 150},   // Rest
                
                {note: 1047, duration: 150}, // C6
                {note: 1175, duration: 150}, // D6
                {note: 1047, duration: 150}, // C6
                {note: 880, duration: 150},  // A5
                {note: 784, duration: 150},  // G5
                {note: 880, duration: 150},  // A5
                {note: 1047, duration: 300}, // C6
                {note: 0, duration: 150},    // Rest
            ];
            
            let noteIndex = 0;
            
            function playBattleNote() {
                if (!gameState.audioEnabled || !audioContext || gameState.score < 50) {
                    playBackgroundMusic(); // Return to normal music
                    return;
                }
                
                const currentNote = battleMelody[noteIndex];
                
                if (currentNote.note > 0) {
                    playMusicNote(currentNote.note, currentNote.duration, musicVolume * 1.2);
                }
                
                noteIndex = (noteIndex + 1) % battleMelody.length;
                
                backgroundMusicInterval = setTimeout(playBattleNote, currentNote.duration);
            }
            
            playBattleNote();
        }
        
        function playSound(frequency = 440, duration = 150, type = 'sine', volume = 0.08) {
            if (!gameState.audioEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            } catch (e) {
                console.log('Audio error:', e);
            }
        }
        
        function playPerfectSound() {
            playSound(880, 150, 'triangle', 0.1);
            setTimeout(() => playSound(1320, 100, 'triangle', 0.08), 80);
        }
        
        function playLevelUpSound() {
            playSound(660, 100, 'triangle', 0.1);
            setTimeout(() => playSound(880, 100, 'triangle', 0.1), 100);
            setTimeout(() => playSound(1100, 150, 'triangle', 0.1), 200);
        }
        
        // Screen Management
        function showScreen(screenName) {
            const screens = ['loading', 'menu', 'instructions', 'game', 'gameover'];
            screens.forEach(name => {
                const screen = document.getElementById(name + '-screen');
                if (screen) {
                    screen.classList.add('hidden');
                }
            });
            
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                currentScreen = screenName;
            }
        }
        
        function showMenu() {
            stopBackgroundMusic(); // Stop music when returning to menu
            showScreen('menu');
            document.getElementById('high-score').textContent = gameState.highScore;
        }
        
        function showInstructions() {
            showScreen('instructions');
        }
        
        function toggleAudio() {
            gameState.audioEnabled = !gameState.audioEnabled;
            
            if (gameState.audioEnabled) {
                initAudio();
                playSound(660, 100);
                // Restart music if in game
                if (currentScreen === 'game' && gameState.gameActive) {
                    setTimeout(() => {
                        if (gameState.score >= 50) {
                            playBattleMusic();
                        } else {
                            playBackgroundMusic();
                        }
                    }, 500);
                }
            } else {
                stopBackgroundMusic();
            }
            
            // Update button text
            const audioButtons = document.querySelectorAll('#audio-btn, #mute-btn');
            audioButtons.forEach(btn => {
                const icon = btn.querySelector('.audio-icon') || btn;
                if (icon.textContent) {
                    icon.textContent = gameState.audioEnabled ? '🔊' : '🔇';
                }
            });
        }
        
        // Optimized Game Logic
        function startGame() {
            gameState.score = 0;
            gameState.streak = 0;
            gameState.level = 1;
            gameState.gameActive = true;
            gameState.blocks = [];
            gameState.currentBlock = null;
            gameState.cameraOffset = 0;
            gamePaused = false;
            
            // Increment games played for session tracking
            window.gamesPlayedSession = (window.gamesPlayedSession || 0) + 1;
            
            // Stop any existing music
            stopBackgroundMusic();
            
            showScreen('game');
            
            // Clear game area
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';
            gameArea.style.transform = 'translateY(0px)';
            
            // Create base block at the bottom
            createBlock(getGameAreaWidth()/2 - 50, 370, 100, '#39FF14', true);
            
            // Create first moving block
            setTimeout(() => createMovingBlock(), 500);
            
            updateUI();
            
            // Start background music
            if (audioContext) {
                audioContext.resume();
                setTimeout(() => {
                    if (gameState.audioEnabled && gameState.gameActive) {
                        playBackgroundMusic();
                    }
                }, 1000);
            }
            
            // Track game start with monetization data
            window.trackEvent('game_start', {
                session_games: window.gamesPlayedSession,
                session_duration: Math.floor((Date.now() - window.sessionStart) / 1000),
                engagement: 'high'
            });
            
            // Show floating ad after engagement (30-60 seconds)
            setTimeout(showFloatingAd, 45000);
        }
        
        function getGameAreaWidth() {
            return document.getElementById('game-area').offsetWidth;
        }
        
        function createBlock(x, y, width, color, isBase = false) {
            const gameArea = document.getElementById('game-area');
            const block = document.createElement('div');
            block.className = 'block';
            block.style.left = x + 'px';
            
            // Ensure blocks are positioned correctly within the game area
            const bottomPosition = Math.max(0, Math.min(370, 400 - y - 30));
            block.style.bottom = bottomPosition + 'px';
            
            block.style.width = width + 'px';
            block.style.background = color;
            block.style.borderColor = color;
            
            gameArea.appendChild(block);
            
            const blockData = { 
                element: block, 
                x, 
                y: Math.max(30, Math.min(400, y)), // Keep Y within reasonable bounds
                width, 
                color,
                isMoving: !isBase,
                direction: 1,
                speed: 2.5 + gameState.level * 0.5
            };
            
            gameState.blocks.push(blockData);
            
            if (!isBase) {
                gameState.currentBlock = blockData;
                animateBlock(blockData);
            }
            
            return blockData;
        }
        
        function createMovingBlock() {
            if (!gameState.gameActive) return;
            
            const lastBlock = gameState.blocks[gameState.blocks.length - 1];
            let newY = lastBlock.y - 35;
            
            // Check if we need to scroll the camera - keep blocks in view
            if (gameState.blocks.length > 8) {
                scrollCameraSmooth();
                // After scroll, position new block above the topmost remaining block
                const topBlock = gameState.blocks[gameState.blocks.length - 1];
                newY = topBlock.y - 35;
            }
            
            // Calculate width based on difficulty
            let newWidth = Math.max(50, 100 - gameState.level * 2);
            
            // Random neon colors
            const colors = ['#FF0080', '#00FFFF', '#8A2BE2', '#39FF14', '#FFFF00', '#FF4500'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            createBlock(0, newY, newWidth, color);
        }
        
        function scrollCameraSmooth() {
            const gameArea = document.getElementById('game-area');
            
            // Show scroll indicator
            showIndicator('¡TORRE REORGANIZADA!');
            
            // Keep only the last 5 blocks and remove old ones
            const blocksToKeep = gameState.blocks.slice(-5);
            
            // Remove old blocks from DOM
            gameState.blocks.forEach((block, index) => {
                if (index < gameState.blocks.length - 5) {
                    if (block.element && block.element.parentNode) {
                        block.element.parentNode.removeChild(block.element);
                    }
                }
            });
            
            // Reposition remaining blocks to bottom of screen
            blocksToKeep.forEach((block, index) => {
                // Position blocks from bottom up
                const newY = 370 - (index * 35); // Start from bottom
                block.y = newY;
                const newBottom = Math.max(0, 400 - newY - 30);
                block.element.style.bottom = newBottom + 'px';
                
                // Add a subtle animation to show the reorganization
                block.element.style.transition = 'bottom 0.5s ease-out';
                setTimeout(() => {
                    block.element.style.transition = 'transform 0.2s ease';
                }, 500);
            });
            
            // Update blocks array
            gameState.blocks = blocksToKeep;
            
            // Play reorganization sound
            playSound(660, 100, 'triangle', 0.08);
            setTimeout(() => playSound(880, 100, 'triangle', 0.08), 100);
        }
        
        function animateBlock(blockData) {
            if (!blockData.isMoving) return;
            
            function animate() {
                if (!blockData.isMoving || !gameState.gameActive || gamePaused) {
                    if (blockData.isMoving && !gamePaused) {
                        requestAnimationFrame(animate);
                    }
                    return;
                }
                
                // Update position
                blockData.x += blockData.speed * blockData.direction;
                
                const gameAreaWidth = getGameAreaWidth();
                
                // Bounce off walls
                if (blockData.x <= 0) {
                    blockData.x = 0;
                    blockData.direction = 1;
                } else if (blockData.x >= gameAreaWidth - blockData.width) {
                    blockData.x = gameAreaWidth - blockData.width;
                    blockData.direction = -1;
                }
                
                // Update element position
                blockData.element.style.left = blockData.x + 'px';
                
                // Continue animation
                if (blockData.isMoving) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }
        
        function stackBlock() {
            if (!gameState.currentBlock || !gameState.currentBlock.isMoving || gamePaused) return;
            
            const current = gameState.currentBlock;
            const previous = gameState.blocks[gameState.blocks.length - 2];
            
            // Stop movement
            current.isMoving = false;
            
            // Calculate overlap
            const overlap = calculateOverlap(current.x, current.width, previous.x, previous.width);
            
            if (overlap <= 10) {
                // Game over
                gameOver();
                return;
            }
            
            // Check if perfect
            const isPerfect = overlap >= current.width * 0.9;
            
            if (isPerfect) {
                gameState.streak++;
                
                let points = 1 + 3; // base + perfect bonus
                if (gameState.streak >= 5) points += 5;
                if (gameState.streak >= 10) points += 10;
                
                gameState.score += points;
                
                // Perfect effects
                current.element.classList.add('perfect');
                playPerfectSound();
                
                // Show indicators
                showIndicator('PERFECTO! +' + (points - 1));
                
                if (gameState.streak >= 5) {
                    showComboIndicator(`${gameState.streak}x COMBO!`);
                }
                
                // Track perfect stack for monetization optimization
                trackPerfectStackEvent(gameState.streak, points);
                
            } else {
                gameState.streak = 0;
                gameState.score += 1;
                
                // Trim block
                const newWidth = overlap;
                const leftEdge = Math.max(current.x, previous.x);
                
                current.width = newWidth;
                current.x = leftEdge;
                current.element.style.width = newWidth + 'px';
                current.element.style.left = leftEdge + 'px';
                
                playSound(440, 120);
            }
            
            // Level up check
            const newLevel = Math.floor(gameState.score / 10) + 1;
            if (newLevel > gameState.level) {
                gameState.level = newLevel;
                showLevelUp();
                playLevelUpSound();
            }
            
            updateUI();
            
            // Create next block
            setTimeout(() => createMovingBlock(), 600);
        }
        
        function calculateOverlap(x1, w1, x2, w2) {
            const left = Math.max(x1, x2);
            const right = Math.min(x1 + w1, x2 + w2);
            return Math.max(0, right - left);
        }
        
        function updateUI() {
            document.getElementById('current-score').textContent = gameState.score;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('level').textContent = gameState.level;
            
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('stackTowerHighScore', gameState.highScore.toString());
            }
            
            // Switch to battle music at high scores
            if (gameState.score === 50 && gameState.audioEnabled && backgroundMusicInterval) {
                playBattleMusic();
                showIndicator('¡MODO BATALLA!');
            }
        }
        
        function showIndicator(text) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.textContent = text;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1000);
        }
        
        function showComboIndicator(text) {
            const existing = document.querySelector('.combo-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'combo-indicator';
            indicator.textContent = text;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1500);
        }
        
        function showLevelUp() {
            const indicator = document.createElement('div');
            indicator.className = 'level-up';
            indicator.textContent = `NIVEL ${gameState.level}!`;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1500);
        }
        
        function gameOver() {
            gameState.gameActive = false;
            stopBackgroundMusic(); // Stop music on game over
            playSound(220, 300, 'sawtooth', 0.15);
            
            // Track game over with monetization metrics
            window.trackEvent('game_over', {
                final_score: gameState.score,
                level_reached: gameState.level,
                blocks_stacked: gameState.blocks.length,
                session_duration: Math.floor((Date.now() - window.sessionStart) / 1000),
                perfect_streak_best: gameState.streak,
                games_this_session: window.gamesPlayedSession,
                engagement: gameState.score > 20 ? 'high' : gameState.score > 10 ? 'medium' : 'low'
            });
            
            setTimeout(() => {
                showViralGameOverScreen();
                
                // Show interstitial ad for engaged users
                setTimeout(() => {
                    showGameOverInterstitial();
                }, 1500);
                
            }, 1000);
        }
        
        function pauseGame() {
            if (!gameState.gameActive) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                document.getElementById('pause-btn').textContent = '▶️ REANUDAR';
                stopBackgroundMusic(); // Pause music
            } else {
                document.getElementById('pause-btn').textContent = '⏸️ PAUSA';
                if (gameState.currentBlock && gameState.currentBlock.isMoving) {
                    animateBlock(gameState.currentBlock);
                }
                // Resume music
                if (gameState.audioEnabled) {
                    setTimeout(() => {
                        if (gameState.score >= 50) {
                            playBattleMusic();
                        } else {
                            playBackgroundMusic();
                        }
                    }, 500);
                }
            }
        }
        
        // Advanced Ad System for Maximum Revenue
        // 🚀 VIRAL SHARING SYSTEM - STACK TOWER
        function showViralGameOverScreen() {
            const score = gameState.score;
            const level = gameState.level;
            const blocks = gameState.blocks.length;
            const isNewRecord = score === gameState.highScore && score > 0;
            
            // Create viral message for Stack Tower
            const shareText = `🏗️ ¡Acabo de conseguir ${score} puntos en Stack Tower Neon! 
🎯 Nivel alcanzado: ${level}
📦 Bloques apilados: ${blocks}
${isNewRecord ? '🏆 ¡NUEVO RÉCORD PERSONAL!' : ''}
🎮 ¿Puedes construir más alto?`;
            
            const gameUrl = 'https://stack-tower-neon2.netlify.app';
            const hashtags = 'StackTower,Gaming,Challenge,Neon';
            
            // Show viral share modal
            const modal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center;" id="viralShareModal">
                    <div style="background: linear-gradient(145deg, #1a1a2e, #16213e); padding: 25px; border-radius: 15px; text-align: center; max-width: 380px; border: 2px solid #00FFFF; box-shadow: 0 0 40px rgba(0,255,255,0.6);">
                        <h2 style="color: ${isNewRecord ? '#FFD700' : '#FF0080'}; margin-bottom: 15px; font-size: 1.4rem;">
                            🏗️ ${isNewRecord ? '🏆 ¡NUEVO RÉCORD!' : 'TORRE CONSTRUIDA!'} 🏗️
                        </h2>
                        <div style="color: #00FFFF; margin-bottom: 20px; font-size: 1.2rem;">
                            🎯 Puntuación: <strong style="color: #FFD700;">${score}</strong><br>
                            📊 Nivel: <strong>${level}</strong><br>
                            📦 Bloques: <strong>${blocks}</strong>
                            ${isNewRecord ? '<br><span style="color: #FFD700; font-weight: bold;">🏆 ¡RÉCORD PERSONAL!</span>' : ''}
                        </div>
                        <div style="margin-bottom: 20px; color: #FFFF00; font-weight: bold; font-size: 1.1rem;">
                            ¡COMPARTE TU TORRE! 🔥
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 15px; justify-content: center; margin-bottom: 20px;">
                            <button onclick="shareStackNative()" style="background: linear-gradient(45deg, #FF0080, #00FFFF); color: white; border: none; padding: 15px 25px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: bold; box-shadow: 0 0 20px rgba(255,0,128,0.5);">🏗️ COMPARTIR TORRE (Elige tu app)</button>
                            <button onclick="copyStackViralMessage()" style="background: linear-gradient(45deg, #00FFFF, #FFFF00); color: #000; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: bold;">📋 COPIAR MENSAJE VIRAL</button>
                            <button onclick="generateStackImage()" style="background: linear-gradient(45deg, #FF0080, #FF8C00); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: bold;">📸 GENERAR IMAGEN TORRE</button>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="closeViralShareModal(); startGame();" style="background: #FF0080; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;">🔄 CONSTRUIR DE NUEVO</button>
                            <button onclick="closeViralShareModal(); showMenu();" style="background: #333; color: white; border: 2px solid #00FFFF; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem;">🏠 MENÚ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Track viral game over event
            window.trackEvent('viral_game_over_shown', {
                score: score,
                level: level,
                blocks: blocks,
                is_new_record: isNewRecord,
                share_modal_shown: true
            });
        }
        
        function closeViralShareModal() {
            const modal = document.getElementById('viralShareModal');
            if (modal) modal.remove();
        }
        
        // 🏗️ STACK TOWER REVOLUTIONARY SHARING FUNCTIONS
        function shareStackNative() {
            const score = gameState.score;
            const level = gameState.level;
            const blocks = gameState.blocks.length;
            const isRecord = score === gameState.highScore && score > 0;
            
            const shareData = {
                title: '🏗️ Stack Tower Neon - ¡Mira mi torre épica!',
                text: `🏗️ ¡Acabo de construir una torre de ${score} puntos en Stack Tower Neon! 🎯 Nivel ${level} 📦 ${blocks} bloques ${isRecord ? '🏆 ¡NUEVO RÉCORD!' : ''} 🎮 ¿Puedes construir más alto?`,
                url: 'https://stack-tower-neon2.netlify.app'
            };

            if (navigator.share) {
                // WEB SHARE API NATIVO - FUNCIONA CON TODAS LAS APPS
                navigator.share(shareData).then(() => {
                    window.trackEvent('stack_native_share_success', { 
                        score: score, 
                        level: level,
                        is_record: isRecord,
                        method: 'web_share_api' 
                    });
                    alert('🎉 ¡Torre compartida exitosamente! Gracias por ayudar a que el juego se vuelva viral 🔥');
                }).catch((error) => {
                    console.log('Share cancelled', error);
                    copyStackViralMessage(); // Fallback
                });
            } else {
                // FALLBACK: Copy to clipboard
                copyStackViralMessage();
            }
        }
        
        function copyStackViralMessage() {
            const score = gameState.score;
            const level = gameState.level;
            const blocks = gameState.blocks.length;
            const isRecord = score === gameState.highScore && score > 0;
            
            const viralMessage = `🏗️ ¡TORRE ÉPICA EN STACK TOWER NEON! 🏗️

🎯 Mi puntuación: ${score} puntos
📊 Nivel alcanzado: ${level}
📦 Bloques apilados: ${blocks}
${isRecord ? '🏆 ¡NUEVO RÉCORD PERSONAL!' : ''}

🎮 ¿PUEDES CONSTRUIR MÁS ALTO?
¡Construye tu torre GRATIS aquí! 👇
https://stack-tower-neon2.netlify.app

#StackTower #Gaming #Challenge #Adictivo #Constructor`;

            navigator.clipboard.writeText(viralMessage).then(() => {
                alert('📋 ¡MENSAJE VIRAL COPIADO! 🔥\n\nAhora pégalo en WhatsApp, Instagram, TikTok o donde quieras.\n\n¡Vamos a hacer que todos construyan torres! 🏗️');
                window.trackEvent('stack_viral_message_copied', { 
                    score: score,
                    level: level,
                    is_record: isRecord,
                    method: 'clipboard_copy'
                });
            }).catch(() => {
                // Show the message in a prompt as fallback
                prompt('📋 Copia este mensaje viral:', viralMessage);
            });
        }
        
        function generateStackImage() {
            // Create a canvas with the tower score
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 600;
            
            // Background gradient (tower theme)
            const gradient = ctx.createLinearGradient(0, 0, 0, 600);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f172a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 600);
            
            // Add neon border
            ctx.strokeStyle = '#00FFFF';
            ctx.lineWidth = 4;
            ctx.strokeRect(10, 10, 380, 580);
            
            // Title
            ctx.fillStyle = '#FF0080';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('🏗️ STACK TOWER NEON', 200, 70);
            
            // Score (big and prominent)
            ctx.fillStyle = '#00FFFF';
            ctx.font = 'bold 56px Arial';
            ctx.fillText(`${gameState.score}`, 200, 160);
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('PUNTOS', 200, 190);
            
            // Stats
            ctx.fillStyle = '#FFFF00';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(`Nivel: ${gameState.level}`, 200, 250);
            ctx.fillText(`Bloques: ${gameState.blocks.length}`, 200, 290);
            
            // Record indicator if applicable
            if (gameState.score === gameState.highScore && gameState.score > 0) {
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('🏆 NUEVO RÉCORD 🏆', 200, 330);
            }
            
            // Challenge text
            ctx.fillStyle = '#FF0080';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('¿PUEDES CONSTRUIR', 200, 400);
            ctx.fillText('MÁS ALTO?', 200, 430);
            
            // URL
            ctx.fillStyle = '#00FFFF';
            ctx.font = '16px Arial';
            ctx.fillText('stack-tower-neon2.netlify.app', 200, 480);
            
            // Convert to image and trigger download
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stack-tower-${gameState.score}pts-nivel${gameState.level}.png`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('📸 ¡Imagen de tu torre generada! Se ha descargado a tu móvil. ¡Compártela en Instagram Stories! 🔥');
                window.trackEvent('stack_share_image_generated', { 
                    score: gameState.score,
                    level: gameState.level,
                    method: 'canvas_download'
                });
            });
        }
        
        function showFloatingAd() {
            if (document.getElementById('floating-ad').classList.contains('hidden')) {
                document.getElementById('floating-ad').classList.remove('hidden');
                window.trackRevenue(0.035, 'display_ads', 'floating_ad');
                window.trackEvent('floating_ad_shown', {
                    session_duration: Math.floor((Date.now() - window.sessionStart) / 1000),
                    games_played: window.gamesPlayedSession
                });
            }
        }
        
        function showRewardedAd() {
            playSound(660, 150);
            
            // Track rewarded ad request
            window.trackEvent('rewarded_ad_request', {
                score_at_request: gameState.score,
                level: gameState.level,
                engagement: 'very_high'
            });
            
            // Show rewarded ad
            window.adBreak({
                type: 'reward',
                name: 'continue_playing',
                beforeAd: () => {
                    console.log('🎬 Showing continue ad...');
                },
                afterAd: () => {
                    console.log('🎬 Continue ad finished');
                },
                adViewed: () => {
                    // Successful ad view - grant continue
                    gameState.gameActive = true;
                    showScreen('game');
                    
                    // Grant bonus points for watching ad
                    gameState.score += 5;
                    showIndicator('¡BONUS +5 PUNTOS!');
                    
                    // Resume music
                    if (gameState.audioEnabled) {
                        setTimeout(() => {
                            if (gameState.score >= 50) {
                                playBattleMusic();
                            } else {
                                playBackgroundMusic();
                            }
                        }, 500);
                    }
                    
                    setTimeout(() => createMovingBlock(), 500);
                    updateUI();
                    
                    window.trackConversion('continue_game', 0.12);
                    // Rewarded Ad Slot: 9988776655
                },
                adDismissed: () => {
                    // Ad was dismissed - offer alternative
                    alert('😔 No hay problema. ¡Inténtalo de nuevo!');
                    window.trackEvent('rewarded_ad_dismissed');
                }
            });
        }
        
        // Interstitial ad on game over (high-value)
        function showGameOverInterstitial() {
            // Only show if score is decent (engagement-based)
            if (gameState.score < 5) return;
            
            window.trackEvent('interstitial_ad_request', {
                final_score: gameState.score,
                session_duration: Math.floor((Date.now() - window.sessionStart) / 1000)
            });
            
            // Show interstitial ad
            window.adBreak({
                type: 'start',
                name: 'game_over_interstitial',
                beforeAd: () => {
                    console.log('🎬 Showing game over interstitial...');
                },
                afterAd: () => {
                    console.log('🎬 Game over interstitial finished');
                },
                adViewed: () => {
                    window.trackConversion('game_over_engagement', 0.08);
                }
            });
        }
        
        function shareScore() {
            const text = `🌈 ¡Conseguí ${gameState.score} puntos en Stack Tower Neon! ¿Puedes superarme?`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Stack Tower Neon',
                    text: text,
                    url: window.location.href
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('¡Puntuación copiada!');
                });
            } else {
                alert(text);
            }
        }
        
        // Controls
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                if (currentScreen === 'game') {
                    stackBlock();
                }
            }
        });
        
        document.addEventListener('click', function(e) {
            if (currentScreen === 'game') {
                if (e.target.closest('#game-screen')) {
                    stackBlock();
                }
            }
        });
        
        document.addEventListener('touchstart', function(e) {
            if (currentScreen === 'game') {
                e.preventDefault();
                stackBlock();
            }
        });
        
        // Advanced Session and Revenue Tracking
        function trackSessionMetrics() {
            const sessionDuration = Math.floor((Date.now() - window.sessionStart) / 1000);
            const avgGameDuration = sessionDuration / Math.max(1, window.gamesPlayedSession);
            
            window.trackEvent('session_metrics', {
                session_duration: sessionDuration,
                games_played: window.gamesPlayedSession,
                total_revenue: window.sessionRevenue,
                avg_game_duration: avgGameDuration,
                engagement_level: avgGameDuration > 60 ? 'very_high' : avgGameDuration > 30 ? 'high' : 'medium'
            });
        }
        
        // Track every 30 seconds for real-time optimization
        setInterval(trackSessionMetrics, 30000);
        
        // Enhanced perfect stack tracking (key engagement metric)
        function trackPerfectStackEvent(streak, points) {
            window.trackEngagement('perfect_stack', 5, {
                streak_length: streak,
                points_earned: points,
                level: gameState.level,
                consecutive_perfects: streak
            });
            
            // Track high-value streaks for user segmentation
            if (streak >= 10) {
                window.trackConversion('expert_player', streak / 10);
            }
        }
        
        // Track user retention signals
        window.addEventListener('beforeunload', () => {
            window.trackEvent('session_end', {
                session_duration: Math.floor((Date.now() - window.sessionStart) / 1000),
                games_played: window.gamesPlayedSession,
                total_revenue: window.sessionRevenue,
                final_score: gameState.score,
                returning_user: localStorage.getItem('stackTowerReturning') === 'true'
            });
            
            // Mark as returning user
            localStorage.setItem('stackTowerReturning', 'true');
        });
        
        // Track page visibility for engagement
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                window.trackEvent('tab_hidden');
            } else {
                window.trackEvent('tab_visible');
            }
        });
        
        // PWA functionality (only for HTTPS/production)
        // Disabled for local testing
        
        // Initialize
        setTimeout(() => {
            initAudio();
            showMenu();
            
            // 💰 INITIALIZE ADSENSE PROPERLY
            setTimeout(() => {
                try {
                    if (window.adsbygoogle) {
                        console.log('✅ AdSense initialized successfully');
                        // Track successful ad load
                        window.trackEvent('adsense_loaded', {
                            ads_blocked: false,
                            publisher_id: 'ca-pub-4129506161314540'
                        });
                    } else {
                        console.warn('⚠️ AdSense blocked or failed to load');
                        window.trackEvent('adsense_blocked', {
                            ads_blocked: true,
                            potential_revenue_lost: 0.10
                        });
                    }
                } catch (e) {
                    console.error('AdSense initialization error:', e);
                }
            }, 2000);
            
            // Track initial load
            window.trackEvent('game_loaded', {
                load_time: Date.now() - window.sessionStart,
                returning_user: localStorage.getItem('stackTowerReturning') === 'true',
                device_type: /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
            });
        }, 1500);
        
        console.log('🌈 Stack Tower Neon - MONETIZATION READY! 💰');
        console.log('📊 Analytics: ✅ | 🎮 H5 Games: ✅ | 💰 AdSense: ✅');
        console.log('🎯 Target: 10,000€/month | 📱 Mobile Optimized | 🔥 Ultra Adictivo');
    </script>
</body>
</html>